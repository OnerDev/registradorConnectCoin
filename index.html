<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ConectCoins - Petra Life</title>
    <style>
        :root { 
            --primary: linear-gradient(135deg, #6c5ce7, #890867); 
            --sec: #00b894; 
            --adm: #e17055; 
            --bg-page: linear-gradient(135deg, #6c5ce7, #890867); 
            --text-color: #5145a8;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-page); 
            margin: 0; padding: 0; 
            color: var(--text-color);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }
        
        header { 
            padding: 30px 15px 10px; text-align: center; width: 100%;
            color: white; position: relative;
        }

        header h1 { margin: 0; font-size: 1.6rem; }

        .btn-sair-icon { 
            position: absolute; right: 20px; top: 30px;
            background: rgba(255,255,255,0.2); border: none; color: white; 
            width: 40px; height: 40px; border-radius: 50%; font-size: 10px;
            font-weight: bold; cursor: pointer;
        }
        
        .container { 
            width: 90%; max-width: 400px; margin: 10px auto; 
            background: white; padding: 30px 25px; border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .user-welcome {
            background: #f1f2f6; padding: 12px; border-radius: 12px;
            margin-bottom: 20px; font-weight: bold; font-size: 0.9rem;
            border-left: 5px solid var(--sec);
        }

        .hidden { display: none; }

        input, select { 
            width: 100%; padding: 15px; margin: 8px 0 15px 0; 
            border: 1px solid #e0e0e0; border-radius: 12px; 
            font-size: 16px; background: #f9fbff; outline: none; display: block;
        }

        button { 
            width: 100%; padding: 16px; border: none; border-radius: 12px; 
            cursor: pointer; font-weight: bold; color: white; font-size: 16px; transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        
        .btn-login { background: var(--primary); }
        .btn-presenca { background: var(--sec); }
        .btn-adm { background: var(--adm); }
        .btn-link { background: none; color: #6c5ce7; text-decoration: none; margin-top: 10px; display: block; text-align: center;}
        
        /* --- NOVO ESTILO PARA O BOT√ÉO DE B√îNUS --- */
        .btn-bonus { 
            background: #f1c40f; /* Dourado para destaque */
            color: #2d3436; font-weight: 800;
            margin-top: 10px;
        }
        /* ----------------------------------------- */

        .card-saldo { 
            background: var(--primary); color: white; text-align: center; 
            padding: 25px; border-radius: 20px; margin-bottom: 20px; 
        }
        
        .tema-container { 
            margin-top: 25px; padding: 20px; background: #f1f2f6; 
            border-radius: 15px; text-align: center; 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 14px; }

        .config-box { background: #fff5f0; padding: 15px; border-radius: 15px; border: 1px dashed var(--adm); }
        .config-item { margin-bottom: 15px; }
        .config-item label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #666; }

        footer {
            margin-top: auto; padding: 25px 15px; color: white;
            font-size: 12px; text-align: center; width: 100%;
            opacity: 0.9; letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

<header>
    <h1 id="txt-logo">ConectCoin‚ú®</h1>
    <span style="font-size: 0.8rem; opacity: 0.8;">Sistema de Moedas Coral de Jovens Petra Life - AD Jaderl√¢ndia</span>
    <button id="logout-btn" class="btn-sair-icon hidden" onclick="logout()">Sair</button>
</header>

<div id="tela-login" class="container">
    <h2 style="margin: 0 0 20px 0;">Entrar</h2>
    <input type="email" id="email" placeholder="lider@email.com">
    <input type="password" id="senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <button class="btn-login" onclick="executarLogin()">Acessar Sistema</button>
    <button class="btn-link" onclick="mostrarCadastro()">Criar conta nova</button>
    
    <div class="tema-container">
        <span style="font-size: 10px; text-transform: uppercase; color: #95a5a6;">Temporada atual:</span>
        <div id="txt-temporada" style="font-weight: bold; font-size: 1.1rem; color: #2d3436;">Carregando...</div>
    </div>
</div>

<div id="tela-auto-cadastro" class="container hidden">
    <h2>Nova Conta</h2>
    <input type="text" id="self-nome" placeholder="Nome Completo">
    <input type="email" id="self-email" placeholder="E-mail">
    <input type="password" id="self-senha" placeholder="Senha">
    <button class="btn-presenca" onclick="enviarAutoCadastro()">Finalizar Cadastro</button>
    <button class="btn-link" onclick="mostrarLogin()">Voltar ao Login</button>
</div>

<div id="painel-jovem" class="container hidden">
    <div class="user-welcome">üëã Ol√°, <span class="u-name"></span>!</div>
    <div class="card-saldo">
        <p style="margin:0; font-size: 0.7rem; opacity: 0.9;">SEU SALDO CONECTCOIN</p>
        <h1 id="meu-saldo" style="margin:10px 0 0 0">0 CC</h1>
    </div>
    <h3>üèÜ Ranking Geral</h3>
    <table><tbody class="rank-body"></tbody></table>
</div>

<div id="painel-lider" class="container hidden">
    <div class="user-welcome">‚≠ê L√≠der: <span class="u-name"></span></div>
    <h3>ü§© Registrar Presen√ßa</h3>
    <select id="lista-jovens"></select>
    <select id="tipo-ativ">
        <option>Culto</option><option>EBD</option><option>Ensaios</option><option>Eventos</option>
    </select>
    <button class="btn-presenca" onclick="enviarPresenca()">Confirmar Presen√ßa</button>
    
    <h3 style="margin-top:30px; margin-bottom: 5px;">üåü Recompensa Especial</h3>
    <p style="font-size: 0.85rem; color: #666; margin: 0 0 10px 0; line-height: 1.3;">
        Atribua +10 pontos extras (comportamento, tarefas, etc) para o jovem selecionado acima.
    </p>
    <button class="btn-bonus" onclick="enviarPontosExtras()">Dar +10 Pontos Extras</button>
    <h3 style="margin-top:30px">üèÜ Ranking Atual</h3>
    <table><tbody class="rank-body"></tbody></table>
</div>

<div id="painel-adm" class="container hidden">
    <div class="user-welcome" style="border-left-color: var(--adm);">‚öôÔ∏è ADM: <span class="u-name"></span></div>
    <h3 style="color: var(--adm); margin-top:0">üé® Personalizar App</h3>
    <div class="config-box">
        <div class="config-item">
            <label>Cor do App:</label>
            <input type="color" id="cfg-color-main">
        </div>
        <div class="config-item">
            <label>Tema da Temporada:</label>
            <input type="text" id="cfg-txt-tema">
        </div>
        <button class="btn-adm" onclick="salvarDesignPermanente()">Salvar para Todos</button>
    </div>
    <h3 style="margin-top:20px">üèÜ Ranking</h3>
    <table><tbody class="rank-body"></tbody></table>
</div>

<footer>
    Feito com ‚ù§Ô∏è por Breno e Larissa
</footer>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbyEJQjOeeroun5pgQCzueNWf2Ex7YtkHSpOoHUXneUmCpZIWwK3GgVNAlCQ67UXbF014Q/exec"; 
    let listaUsuarios = [];

    // Fun√ß√£o para buscar dados atualizados do servidor sem deslogar
    async function atualizarDadosLocais() {
        try {
            const res = await fetch(URL_API);
            const dados = await res.json();
            listaUsuarios = dados.usuarios;
            renderizarRankings();
            
            const emailLogado = document.getElementById('email').value.trim().toLowerCase();
            const user = listaUsuarios.find(u => u.email.toLowerCase() === emailLogado);
            if (user && user.tipo === 'jovem') {
                document.getElementById('meu-saldo').innerText = user.saldo + " CC";
            }
        } catch (e) {
            console.error("Erro ao atualizar dados:", e);
        }
    }

    window.onload = async () => {
        try {
            const res = await fetch(URL_API);
            const dados = await res.json();
            if(dados.config) {
                document.getElementById('txt-temporada').innerText = `"${dados.config.tema}"`;
                document.documentElement.style.setProperty('--primary', dados.config.cor);
                document.documentElement.style.setProperty('--bg-page', dados.config.cor);
            }
        } catch (e) { document.getElementById('txt-temporada').innerText = "Erro ao carregar tema"; }
    };

    function logout() { location.reload(); }
    function mostrarCadastro() { document.getElementById('tela-login').classList.add('hidden'); document.getElementById('tela-auto-cadastro').classList.remove('hidden'); }
    function mostrarLogin() { document.getElementById('tela-auto-cadastro').classList.add('hidden'); document.getElementById('tela-login').classList.remove('hidden'); }

    async function executarLogin() {
        const btn = document.querySelector('.btn-login');
        btn.innerText = "Entrando...";
        try {
            const res = await fetch(URL_API);
            const dados = await res.json();
            listaUsuarios = dados.usuarios;
            
            const email = document.getElementById('email').value.trim().toLowerCase();
            const senha = document.getElementById('senha').value;
            const user = listaUsuarios.find(u => u.email.toLowerCase() === email && String(u.senha) === senha);

            if (!user) { alert("Usu√°rio ou senha incorretos!"); btn.innerText = "Acessar Sistema"; return; }

            document.getElementById('tela-login').classList.add('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.querySelectorAll('.u-name').forEach(el => el.innerText = user.nome);

            renderizarRankings();

            if (user.tipo === 'jovem') {
                document.getElementById('painel-jovem').classList.remove('hidden');
                document.getElementById('meu-saldo').innerText = user.saldo + " CC";
            } else if (user.tipo === 'lider') {
                document.getElementById('painel-lider').classList.remove('hidden');
                carregarLider();
            } else if (user.tipo === 'adm') {
                document.getElementById('painel-adm').classList.remove('hidden');
                document.getElementById('cfg-color-main').value = dados.config.cor;
                document.getElementById('cfg-txt-tema').value = dados.config.tema;
            }
        } catch(e) { 
            console.error(e);
            alert("Erro de conex√£o com o servidor!"); 
            btn.innerText = "Acessar Sistema"; 
        }
    }

    async function enviarPresenca() {
        const btn = document.querySelector('.btn-presenca');
        const originalText = btn.innerText;
        btn.innerText = "Registrando...";
        btn.disabled = true;

        const emailSelect = document.getElementById('lista-jovens');
        const email = emailSelect.value;
        const atividade = document.getElementById('tipo-ativ').value;
        
        if (!email) {alert("Selecione um jovem."); btn.innerText = originalText; btn.disabled = false; return;}

        try {
            await fetch(URL_API, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({acao:'presenca', email, atividade}) 
            });
            
            alert("Presen√ßa registrada com sucesso!");
            await atualizarDadosLocais();
            
        } catch (e) {
            alert("Erro ao salvar presen√ßa.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // --- NOVA FUN√á√ÉO PARA ENVIAR PONTOS EXTRAS ---
    async function enviarPontosExtras() {
        const btn = document.querySelector('.btn-bonus');
        const emailSelect = document.getElementById('lista-jovens');
        const email = emailSelect.value;

        if (!email) {alert("Selecione um jovem na lista acima primeiro."); return;}

        // Obt√©m o nome do jovem selecionado para a mensagem de confirma√ß√£o
        const nomeJovem = emailSelect.options[emailSelect.selectedIndex].text;
        const originalText = btn.innerText;

        // Confirma√ß√£o de seguran√ßa
        if (!confirm(`ATEN√á√ÉO:\nDeseja realmente dar +10 pontos extras para: ${nomeJovem}?`)) {
            return;
        }

        btn.innerText = "Enviando b√¥nus...";
        btn.disabled = true;

        try {
            // Envia a nova a√ß√£o 'pontos_extras' para o backend
            await fetch(URL_API, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({
                    acao: 'pontos_extras', 
                    email: email,
                    valor: 10
                }) 
            });
            
            alert(`Sucesso! +10 pontos enviados para ${nomeJovem}.`);
            // Atualiza o ranking na tela imediatamente
            await atualizarDadosLocais();
            
        } catch (e) {
            alert("Erro ao enviar pontos extras.");
            console.error(e);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    // ---------------------------------------------

    function renderizarRankings() {
        const ranking = [...listaUsuarios].filter(x => x.tipo === 'jovem').sort((a,b) => b.saldo - a.saldo);
        const html = ranking.map((x, i) => `<tr><td>${i+1}¬∫</td><td>${x.nome}</td><td><strong>${x.saldo}</strong> CC</td></tr>`).join('');
        document.querySelectorAll(".rank-body").forEach(tb => tb.innerHTML = html);
    }

    function carregarLider() {
        const select = document.getElementById('lista-jovens');
        // Adiciona uma op√ß√£o vazia inicial
        let options = '<option value="" disabled selected>Selecione um Jovem...</option>';
        options += listaUsuarios.filter(u => u.tipo === 'jovem').map(j => `<option value="${j.email}">${j.nome}</option>`).join('');
        select.innerHTML = options;
    }

    async function enviarAutoCadastro() {
        const btn = document.querySelector('#tela-auto-cadastro .btn-presenca');
        const nome = document.getElementById('self-nome').value.trim();
        const email = document.getElementById('self-email').value.trim().toLowerCase();
        const senha = document.getElementById('self-senha').value;

        if(!nome || !email || !senha) { return alert("Por favor, preencha todos os campos!"); }

        btn.disabled = true;
        btn.innerText = "Criando conta... aguarde";

        try {
            await fetch(URL_API, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({acao: 'cadastrar', nome, email, senha, tipo: 'jovem'}) 
            });

            alert("Conta criada com sucesso! Agora voc√™ pode fazer login.");
            document.getElementById('self-nome').value = "";
            document.getElementById('self-email').value = "";
            document.getElementById('self-senha').value = "";
            mostrarLogin();
        } catch (e) {
            console.error(e);
           alert("Erro ao realizar cadastro. Tente novamente.");
        } finally {
           btn.disabled = false;
           btn.innerText = "Finalizar Cadastro";
        }
    }

    async function salvarDesignPermanente() {
        const btn = document.querySelector('.btn-adm');
        btn.innerText = "Salvando..."; btn.disabled = true;
        const cor = document.getElementById('cfg-color-main').value;
        const tema = document.getElementById('cfg-txt-tema').value;
        try {
            await fetch(URL_API, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({acao: 'salvarDesign', cor, tema})
            });
            alert("Design salvo com sucesso!");
            document.documentElement.style.setProperty('--primary', cor);
            document.documentElement.style.setProperty('--bg-page', cor);
        } catch(e) {alert("Erro ao salvar");}
        finally { btn.innerText = "Salvar para Todos"; btn.disabled = false; }
    } 
</script>
</body>
</html>